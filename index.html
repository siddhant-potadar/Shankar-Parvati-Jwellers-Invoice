<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f9f9f9;
      color: #333;
    }
    .invoice-container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .brand-header {
      background-color: #f8e9c0;
      padding: 0;
      width: 100%;
      display: block;
    }
    .brand-image {
      width: 100%;
      display: block;
    }
    .invoice-title-block {
      background-color: #8b0000;
      color: white;
      padding: 5px 10px;
      text-align: center;
    }
    .invoice-title {
      font-size: 24px;
      margin: 0;
      font-weight: bold;
    }
    .invoice-body {
      padding: 10px;
    }
    .customer-details {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .bill-info {
      flex: 1;
    }
    .invoice-meta {
      flex: 1;
      text-align: right;
    }
    .bill-info h3, .invoice-meta h3 {
      margin-top: 0;
      margin-bottom: 5px;
    }
    .editable-field {
      border: 1px solid #ddd;
      padding: 3px 5px;
      border-radius: 4px;
      margin: 1px 0;
      display: inline-block;
      min-width: 150px;
    }
    .editable-field:focus {
      outline: none;
      border-color: #8b0000;
      box-shadow: 0 0 3px rgba(139, 0, 0, 0.3);
    }
    .label {
      font-weight: bold;
      margin-right: 5px;
    }
    p {
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th {
      background-color: #f2f2f2;
      padding: 6px;
      text-align: left;
      border-bottom: 2px solid #ddd;
      font-size: 14px;
    }
    td {
      padding: 6px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .editable-cell {
      background-color: #fafafa;
      border: 1px solid #eee;
    }
    .editable-cell:focus {
      outline: none;
      border-color: #8b0000;
      background-color: #fff;
    }
    .totals {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }
    .totals-table {
      width: 300px;
    }
    .totals-table td {
      padding: 4px;
    }
    .totals-table .grand-total {
      font-weight: bold;
      font-size: 16px;
      border-top: 2px solid #8b0000;
    }
    .signature {
      margin-top: 15px;
      text-align: right;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .signature p {
      margin: 0;
    }
    .highlight {
      color: #8b0000;
      font-weight: bold;
    }
    .btn {
      background-color: #8b0000;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 5px;
      margin-right: 5px;
      font-size: 13px;
    }
    .btn:hover {
      background-color: #a50000;
    }
    .delete-row {
      color: #8b0000;
      cursor: pointer;
      font-weight: bold;
    }
    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
    }
    .hidden-in-print {
      display: block;
    }
    #pdf-status {
      display: none;
      padding: 10px;
      margin-top: 10px;
      background-color: #f0f0f0;
      border-radius: 4px;
      text-align: center;
    }
    @media print {
      .hidden-in-print {
        display: none !important;
      }
      body {
        padding: 0;
        background-color: white;
      }
      .invoice-container {
        box-shadow: none;
        max-width: 100%;
      }
      .editable-field, .editable-cell {
        border: none;
        padding: 3px 0;
      }
    }
  </style>
  <link rel="icon" href="data:,">

</head>
<body>
  <div class="invoice-container" id="invoice">
    <div class="brand-header">
      <img src="./Image/image.png" alt="शंकर पार्वती ज्वेलर्स" class="brand-image">
    </div>
    
    <div class="invoice-title-block">
      <h1 class="invoice-title">Proforma Invoice</h1>
    </div>
    
    <div class="invoice-body">
      <div class="customer-details">
        <div class="bill-info">
          <h3>Customer Details:</h3>
          <p>
            <span class="label">Name:</span>
            <span class="editable-field" contenteditable="true">शामराव माांगोरे</span>
          </p>
          <p>
            <span class="label">Address:</span>
            <span class="editable-field" contenteditable="true">कुरणी, लक्ष्मीहार</span>
          </p>
        </div>
        <div class="invoice-meta">
          <h3>&nbsp;</h3>
          <p>
            <span class="label">Bill No:</span>
            <span class="editable-field" contenteditable="true">1</span>
          </p>
          <p>
            <span class="label">Date:</span>
            <span class="editable-field" contenteditable="true">30/10/2024</span>
          </p>
        </div>
      </div>
      
      <table id="invoice-items">
        <thead>
          <tr>
            <th>Sr.No</th>
            <th>Item Name</th>
            <th>Purity</th>
            <th>Gold Rate/g</th>
            <th>Gross Wt</th>
            <th>Net Wt</th>
            <th>Making/g</th>
            <th>Total</th>
            <th class="hidden-in-print"></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td contenteditable="true" class="editable-cell">1</td>
            <td contenteditable="true" class="editable-cell">Gold Necklace</td>
            <td contenteditable="true" class="editable-cell">22k</td>
            <td contenteditable="true" class="editable-cell gold-rate">7350</td>
            <td contenteditable="true" class="editable-cell">17.21</td>
            <td contenteditable="true" class="editable-cell net-weight">10.5</td>
            <td contenteditable="true" class="editable-cell making-charge">950</td>
            <td class="item-total">₹86,975</td>
            <td class="delete-row hidden-in-print">✕</td>
          </tr>
        </tbody>
      </table>
      
      <div class="action-buttons hidden-in-print">
        <button class="btn" id="add-row">+ Add New Row</button>
        <button class="btn" id="export-pdf">Export as PDF</button>
      </div>
      
      <div id="pdf-status" class="hidden-in-print">Generating PDF...</div>
      
      <div class="totals">
        <table class="totals-table">
          <tr>
            <td>Total:</td>
            <td id="invoice-total">₹86,975</td>
          </tr>
          <tr>
            <td>Additional Charges:</td>
            <td contenteditable="true" class="editable-cell" id="additional-charges">0</td>
          </tr>
          <tr class="grand-total">
            <td>Grand Total:</td>
            <td id="grand-total" class="highlight">₹86,975</td>
          </tr>
          <tr>
            <td>Amount Paid:</td>
            <td contenteditable="true" class="editable-cell" id="amount-paid">0</td>
          </tr>
          <tr>
            <td>Due Amount:</td>
            <td id="due-amount" class="highlight">₹86,975</td>
          </tr>
        </table>
      </div>
      
      <div class="signature">
        <p>Authorized Signature</p>
        <hr style="width: 150px; margin-left: auto; margin-top: 5px; margin-bottom: 0; border-top: 1px solid #333;">
      </div>
    </div>
  </div>

  <!-- Include html2pdf library with direct CDN link -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const addRowButton = document.getElementById('add-row');
      const exportPdfButton = document.getElementById('export-pdf');
      const itemsTable = document.getElementById('invoice-items');
      const additionalChargesField = document.getElementById('additional-charges');
      const amountPaidField = document.getElementById('amount-paid');
      const pdfStatus = document.getElementById('pdf-status');
      
      // Format number as Indian currency
      function formatCurrency(num) {
        return '₹' + parseFloat(num).toLocaleString('en-IN', {
          maximumFractionDigits: 0
        });
      }
      
      // Extract number from formatted currency string
      function extractNumber(str) {
        return parseFloat(str.replace(/[^\d.-]/g, '')) || 0;
      }
      
      // Calculate item total
      function calculateItemTotal(row) {
        const goldRate = extractNumber(row.querySelector('.gold-rate').textContent);
        const netWeight = extractNumber(row.querySelector('.net-weight').textContent);
        const makingCharge = extractNumber(row.querySelector('.making-charge').textContent);
        
        // Total = (Net Weight × Gold Rate) + (Making Charges × Net Weight)
        const total = (netWeight * goldRate) + (makingCharge * netWeight);
        
        row.querySelector('.item-total').textContent = formatCurrency(total);
        return total;
      }
      
      // Calculate invoice totals
      function calculateInvoiceTotals() {
        // Calculate sum of all item totals
        const rows = itemsTable.querySelectorAll('tbody tr');
        let invoiceTotal = 0;
        
        rows.forEach(row => {
          const itemTotal = calculateItemTotal(row);
          invoiceTotal += itemTotal;
        });
        
        // Update invoice total
        document.getElementById('invoice-total').textContent = formatCurrency(invoiceTotal);
        
        // Calculate grand total (invoice total + additional charges)
        const additionalCharges = extractNumber(additionalChargesField.textContent);
        const grandTotal = invoiceTotal + additionalCharges;
        document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
        
        // Calculate due amount (grand total - amount paid)
        const amountPaid = extractNumber(amountPaidField.textContent);
        const dueAmount = grandTotal - amountPaid;
        document.getElementById('due-amount').textContent = formatCurrency(dueAmount);
      }
      
      // Add row functionality
      addRowButton.addEventListener('click', function() {
        const tbody = itemsTable.querySelector('tbody');
        const rowCount = tbody.querySelectorAll('tr').length + 1;
        
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td contenteditable="true" class="editable-cell">${rowCount}</td>
          <td contenteditable="true" class="editable-cell"></td>
          <td contenteditable="true" class="editable-cell">22k</td>
          <td contenteditable="true" class="editable-cell gold-rate">7350</td>
          <td contenteditable="true" class="editable-cell">0</td>
          <td contenteditable="true" class="editable-cell net-weight">0</td>
          <td contenteditable="true" class="editable-cell making-charge">950</td>
          <td class="item-total">₹0</td>
          <td class="delete-row hidden-in-print">✕</td>
        `;
        
        tbody.appendChild(newRow);
        
        // Add event listeners to the new row
        setupRowEventListeners(newRow);
        
        // Add event listener to the new delete button
        setupDeleteButtons();
        
        // Calculate totals
        calculateInvoiceTotals();
      });
      
      // Setup row event listeners
      function setupRowEventListeners(row) {
        const editableCells = row.querySelectorAll('.editable-cell');
        editableCells.forEach(cell => {
          cell.addEventListener('input', function() {
            calculateInvoiceTotals();
          });
          
          cell.addEventListener('blur', function() {
            calculateInvoiceTotals();
          });
        });
      }
      
      // Setup delete row functionality
      function setupDeleteButtons() {
        const deleteButtons = document.querySelectorAll('.delete-row');
        deleteButtons.forEach(button => {
          button.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this row?')) {
              const row = this.parentNode;
              row.parentNode.removeChild(row);
              updateRowNumbers();
              calculateInvoiceTotals();
            }
          });
        });
      }
      
      // Update row numbers after deletion
      function updateRowNumbers() {
        const rows = itemsTable.querySelectorAll('tbody tr');
        rows.forEach((row, index) => {
          row.cells[0].textContent = index + 1;
        });
      }
      
      // Add event listeners to additional charges and amount paid
      additionalChargesField.addEventListener('input', calculateInvoiceTotals);
      additionalChargesField.addEventListener('blur', calculateInvoiceTotals);
      amountPaidField.addEventListener('input', calculateInvoiceTotals);
      amountPaidField.addEventListener('blur', calculateInvoiceTotals);
      
      // FIXED: PDF Export functionality
      exportPdfButton.addEventListener('click', function() {
        try {
          // Show status message
          pdfStatus.style.display = 'block';
          pdfStatus.textContent = 'Generating PDF...';
          
          // Get customer name for filename
          const customerName = document.querySelector('.bill-info .editable-field').textContent.trim();
          const billNo = document.querySelector('.invoice-meta .editable-field').textContent.trim();
          const filename = `Invoice_${billNo}_${customerName}.pdf`;
          
          // Create a deep clone of the invoice for printing
          const originalInvoice = document.getElementById('invoice');
          const printInvoice = originalInvoice.cloneNode(true);
          
          // Add to DOM temporarily but hide it
          printInvoice.style.position = 'absolute';
          printInvoice.style.left = '-9999px';
          document.body.appendChild(printInvoice);
          
          // Remove all elements with hidden-in-print class from the cloned element
          printInvoice.querySelectorAll('.hidden-in-print').forEach(el => {
            el.remove();
          });
          
          // Configure PDF options
          const options = {
            margin: 10,
            filename: filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, logging: false },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          };
          
          // Generate PDF
          html2pdf().from(printInvoice).set(options).save()
            .then(() => {
              // Success message
              pdfStatus.textContent = 'PDF generated successfully!';
              setTimeout(() => {
                pdfStatus.style.display = 'none';
              }, 3000);
              
              // Remove the temporary clone
              document.body.removeChild(printInvoice);
            })
            .catch(error => {
              console.error('PDF generation error:', error);
              pdfStatus.textContent = 'Error generating PDF. Please try again.';
              
              // Remove the temporary clone
              if (document.body.contains(printInvoice)) {
                document.body.removeChild(printInvoice);
              }
            });
        } catch (error) {
          console.error('PDF function error:', error);
          pdfStatus.textContent = 'Error: ' + error.message;
        }
      });
      
      // Setup all existing rows
      const existingRows = itemsTable.querySelectorAll('tbody tr');
      existingRows.forEach(row => {
        setupRowEventListeners(row);
      });
      
      // Initial setup
      setupDeleteButtons();
      calculateInvoiceTotals();
    });
  </script>
</body>
</html>
